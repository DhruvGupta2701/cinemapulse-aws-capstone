{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block title %}Admin Control Room | CinemaPulse{% endblock %}

{% block content %}
<nav class="navbar">
    <div class="logo">
        <i class="fa-solid fa-film pulse-icon"></i>
        Cinema<span class="text-highlight">Pulse</span>
    </div>

    <ul class="nav-links">
        <a href="/">Home</a>
        <li><a href="/contact">Contact</a></li>
        <li><a href="/about">About</a></li>
        <li><a href="/logout" class="btn-login">Logout</a></li>
       
    </ul>

    <div class="hamburger">
        <i class="fa-solid fa-bars"></i>
    </div>
</nav>
<div class="admin-dashboard">

    <!-- ================= HEADER ================= -->
    <header class="dashboard-header">
        <div class="header-text">
            <h1 class="text-gradient">Admin Control Room</h1>
            <p class="dashboard-subtext">Real-time audience intelligence & content management</p>
        </div>
        <div class="live-indicator">
            <span class="pulse-dot"></span> 
            <span>System Live</span>
        </div>
    </header>

    <!-- ================= STATS ================= -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-film"></i></div>
            <div>
                <h3>Total Movies</h3>
                <p>{{ movies|length }}</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-comments"></i></div>
            <div>
                <h3>Total Feedbacks</h3>
                <p>{{ movies.values()|map(attribute="feedbacks")|map("length")|sum }}</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-server"></i></div>
            <div>
                <h3>System Status</h3>
                <p class="status-ok">Online</p>
            </div>
        </div>
    </div>

    <!-- ================= MAIN LAYOUT ================= -->
    <div class="dashboard-layout">

        <section class="main-column">

            <!-- ================= CONTROLS ================= -->
            <div class="controls-bar">
                <div class="search-wrapper">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" placeholder="Search movies..." class="movie-search">
                </div>

                <select class="movie-filter">
                    <option value="all">All Genres</option>
                    <option value="action">Action</option>
                    <option value="drama">Drama</option>
                    <option value="thriller">Thriller</option>
                    <option value="sci-fi">Sci-Fi</option>
                    <option value="romance">Romance</option>
                </select>

                <select class="movie-filter"> <!-- Sort By -->
                    <option value="default">Sort By</option>
                    <option value="score-desc">Highest Score</option>
                    <option value="score-asc">Lowest Score</option>
                    <option value="trend-up">Trending Up</option>
                    <option value="trend-down">Trending Down</option>
                </select>
            </div>

            <!-- ================= MOVIE GRID ================= -->
            <div class="movie-feed-grid">
                {% for key, movie in movies.items() %}
                <div class="movie-card" data-genre="{{ movie.genre|lower }}">

                    <!-- ================= POSTER ================= -->
                    <div class="poster-wrapper">
                        <img src="{{ movie.image }}" class="movie-poster" alt="{{ movie.name }}">
                        <div class="poster-overlay">
                            <span class="rating-badge">‚≠ê {{ movie.rating }}</span>
                        </div>
                    </div>

                    <div class="movie-content">

                        <!-- ================= MOVIE ANALYTICS ================= -->
                        <div class="analytics-panel">
                            <div class="score-box">
                                <span class="score-title">CinemaPulse Score</span>
                                <span class="score-value">
                                    {{ movie.analytics.score if movie.analytics else 0 }}/100
                                </span>
                            </div>

                            <div class="trend-box {{ movie.analytics.trend|lower|replace(' ', '-') if movie.analytics else 'stable' }}">
                                <i class="fas fa-chart-line"></i>
                                {{ movie.analytics.trend if movie.analytics else "Stable" }}
                            </div>

                            <div class="breakdown-bar">
                                <div class="positive" style="width: {{ movie.analytics.breakdown.positive if movie.analytics else 0 }}%"></div>
                                <div class="neutral"  style="width: {{ movie.analytics.breakdown.neutral if movie.analytics else 0 }}%"></div>
                                <div class="negative" style="width: {{ movie.analytics.breakdown.negative if movie.analytics else 0 }}%"></div>
                            </div>

                            <div class="breakdown-labels">
                                <span>üòä {{ movie.analytics.breakdown.positive if movie.analytics else 0 }}%</span>
                                <span>üòê {{ movie.analytics.breakdown.neutral if movie.analytics else 0 }}%</span>
                                <span>üòû {{ movie.analytics.breakdown.negative if movie.analytics else 0 }}%</span>
                            </div>
                        </div>

                        <!-- ================= MOVIE HEADER ================= -->
                        <div class="movie-header">
                            <div class="header-top">
                                <h2>{{ movie.name }}</h2>
                            </div>
                            <span class="movie-meta">
                                <span class="tag genre-tag">{{ movie.genre }}</span>
                                <span class="tag lang-tag">{{ movie.language }}</span>
                            </span>
                        </div>

                        <!-- ================= FEEDBACK ================= -->
                        <div class="feedback-section">
                            <h4 class="section-label">Recent Feedback</h4>
                            <div class="feedback-list">
                                {% if movie.feedbacks %}
                                    {% for fb in movie.feedbacks %}
                                    <div class="feedback-bubble">
                                        <div>
                                            <p><strong>Rating:</strong> ‚≠ê {{ fb.rating }}</p>
                                            <p>{{ fb.comment }}</p>
                                            <small style="color:#888;">
                                                By: {{ fb.user_email }} | {{ fb.timestamp }}
                                            </small>
                                            <p style="font-size:0.75rem; color:#FFE66D;">
                                                AI Sentiment: {{ fb.sentiment }}
                                            </p>
                                        </div>

                                        <form method="POST" action="/admin/feedback/delete" class="delete-fb-form">
                                            <input type="hidden" name="feedback_id" value="{{ fb.id }}">
                                            <button type="submit" class="icon-btn-danger" title="Remove Feedback">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </form>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="no-feedback">No feedback yet.</p>
                                {% endif %}
                            </div>
                        </div>

                        <!-- ================= ACTIONS ================= -->
                        <div class="movie-actions">
                            <button class="action-btn edit-btn" 
                                data-name="{{ movie.name }}" 
                                data-genre="{{ movie.genre }}" 
                                data-language="{{ movie.language }}" 
                                data-rating="{{ movie.rating }}" 
                                data-image="{{ movie.image }}">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="action-btn delete-btn" data-name="{{ movie.name }}">
                                <i class="fas fa-trash-alt"></i> Delete
                            </button>
                        </div>

                    </div>
                </div>
                {% endfor %}
            </div>
        </section>

        <!-- ================= SIDEBAR ================= -->
        <aside class="sidebar-column">
            <div class="sidebar-content">
                <div class="panel-card actions-panel">
                    <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                    <button class="primary-btn full-width" onclick="openAddModal()">
                        <i class="fas fa-plus-circle"></i> Add New Movie
                    </button>
                </div>

                <div class="panel-card chart-panel">
                    <h3>Genre Analytics</h3>
                    <div class="chart-container">
                        <canvas id="genrePieChart"></canvas>
                    </div>
                    <div class="chart-legend">
                        <p class="small-text">Average rating distribution by genre</p>
                    </div>
                </div>
            </div>
        </aside>

    </div>
</div>

<!-- ================= MOVIE MODAL ================= -->
<div class="movie-modal" id="movieModal">
    <form class="modal-box" method="POST" id="movieForm">
        <div class="modal-header">
            <h2 id="modalTitle">Manage Movie</h2>
            <button type="button" class="close-icon" onclick="closeModal()"><i class="fas fa-times"></i></button>
        </div>

        <input type="hidden" id="oldMovieName" name="old_name">

        <div id="deleteWarning" class="warning-box" style="display:none;">
            <i class="fas fa-exclamation-triangle"></i>
            <p>You are about to delete this movie. This action cannot be undone.</p>
        </div>

        <div class="form-group">
            <label>Movie Name</label>
            <input name="name" id="movieName" placeholder="Enter title..." required>
        </div>

        <div class="form-row">
            <div class="form-group half">
                <label>Genre</label>
                <input name="genre" id="movieGenre" placeholder="Action, Drama...">
            </div>
            <div class="form-group half">
                <label>Language</label>
                <input name="language" id="movieLanguage" placeholder="English, Hindi...">
            </div>
        </div>

        <div class="form-group">
            <label>Poster URL</label>
            <input name="image" id="movieImage" placeholder="https://...">
        </div>


        <div class="modal-actions">
            <button type="button" class="cancel-btn" onclick="closeModal()">Cancel</button>
            <button type="submit" class="save-btn">Confirm Action</button>
        </div>
    </form>
</div>

<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard_style.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/script.js') }}"></script>
{% endblock %}
